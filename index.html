<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Market Update Bot </title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-base: #000000;
            --bg-surface: #0d0d0d;
            --bg-panel: #171717;
            --border-primary: #2d2d2d;
            --text-main: #ececec;
            --text-dim: #888888;
            --accent-green: #10a37f;
            --accent-red: #d94e4e;
            --accent-amber: #d97706;
            --shadow-premium: 0 20px 50px rgba(0,0,0,0.8);
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg-base);
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            color: var(--text-main);
            padding: 10px;
        }

        .app {
            width: 100%; max-width: 500px; height: 92vh;
            background: var(--bg-surface);
            border-radius: 32px;
            display: flex; flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-premium);
            position: relative;
        }

        .header {
            padding: 24px 24px 16px;
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg-surface);
            z-index: 10;
        }

        .header h1 { font-size: 1.25rem; font-weight: 700; color: #fff; }

        .menu-btn {
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 14px; background: var(--bg-panel);
            border: 1px solid var(--border-primary);
            cursor: pointer;
        }

        .chat-area {
            flex: 1; padding: 0 20px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
            padding-bottom: 20px;
        }
        .chat-area::-webkit-scrollbar { width: 0; }

        .message { display: flex; flex-direction: column; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message.bot { align-items: flex-start; }
        .message.user { align-items: flex-end; }

        .bubble {
            max-width: 95%; padding: 16px 20px;
            border-radius: 24px; font-size: 0.95rem; line-height: 1.6;
        }

        .bot .bubble { background: var(--bg-panel); color: var(--text-main); border: 1px solid var(--border-primary); border-bottom-left-radius: 4px; }
        .user .bubble { background: #fff; color: #000; font-weight: 500; border-bottom-right-radius: 4px; }

        .analysis-card { width: 100%; background: #0a0a0a; border-radius: 20px; padding: 15px; border: 1px solid var(--border-primary); margin-top: 10px; }
        .card-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #1a1a1a; }
        .card-row:last-child { border: 0; }
        .label { color: var(--text-dim); font-size: 0.8rem; }
        .value { font-weight: 600; font-size: 0.85rem; }

        /* TradingView Chart Container */
        .chart-container {
            width: 100%;
            height: 200px;
            margin-top: 12px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #222;
        }

        .signal-pill { padding: 4px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; }
        .buy { background: rgba(16, 163, 127, 0.15); color: var(--accent-green); }
        .sell { background: rgba(217, 78, 78, 0.15); color: var(--accent-red); }
        .hold { background: rgba(217, 119, 6, 0.15); color: var(--accent-amber); }

        .chip-container { display: flex; gap: 8px; overflow-x: auto; padding: 0 20px 15px; }
        .chip { white-space: nowrap; padding: 8px 16px; background: var(--bg-panel); border: 1px solid var(--border-primary); border-radius: 100px; font-size: 0.8rem; font-weight: 600; color: var(--text-dim); cursor: pointer; }

        .input-wrapper { padding: 16px 20px 10px; background: var(--bg-surface); border-top: 1px solid var(--border-primary); z-index: 5; }
        .input-box { background: var(--bg-panel); border: 1px solid var(--border-primary); border-radius: 100px; padding: 6px 6px 6px 20px; display: flex; align-items: center; gap: 10px; }
        .input-box input { flex: 1; background: transparent; border: none; color: #fff; font-size: 1rem; outline: none; }
        .send-btn { width: 44px; height: 44px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }

        .ad-footer {
            width: 100%; 
            height: 110px;
            background: #111;
            border-top: 1px solid var(--border-primary);
            position: relative; cursor: pointer;
            overflow: hidden;
        }
        .ad-footer img { width: 100%; height: 100%; object-fit: cover; object-position: center; }
        .close-ad { position: absolute; top: 8px; right: 12px; color: #fff; background: rgba(0,0,0,0.6); width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; z-index: 20; }

        .sidebar { position: absolute; top: 0; left: -100%; width: 80%; height: 100%; background: var(--bg-surface); z-index: 100; transition: left 0.3s ease; padding: 40px 24px; border-right: 1px solid var(--border-primary); }
        .sidebar.open { left: 0; }
        .sidebar-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 90; display: none; }
    </style>
</head>
<body>

<div class="app">
    <div class="sidebar-overlay" id="overlay"></div>
    <div class="sidebar" id="sidebar">
        <div style="display:flex; justify-content:space-between; margin-bottom:40px;">
            <h2 style="font-size:1.2rem;">Terminal</h2>
            <i class="fas fa-times" id="closeMenu" style="cursor:pointer;"></i>
        </div>
        <div style="color: var(--text-dim); font-size: 0.8rem; margin-bottom: 20px;">DEVELOPER</div>
        <div onclick="window.open('https://instagram.com/_fayizeeyy')" style="cursor:pointer; color:#fff; display:flex; align-items:center; gap:10px; margin-bottom:20px;">
            <i class="fab fa-instagram"></i> @_fayizeeyy
        </div>
    </div>

    <header class="header">
        <h1>Market Bot <span style="color:var(--accent-green)">●</span></h1>
        <div class="menu-btn" id="menuBtn"><i class="fas fa-bars-staggered" style="color:#888;"></i></div>
    </header>

    <div class="chat-area" id="chat">
        <div class="message bot">
            <div class="bubble">AI Terminal-lekku swagatham. Real-time analysis-inu vendi oru NSE ticker (e.g., RELIANCE) enter cheyyuka.</div>
        </div>
    </div>

    <div class="chip-container">
        <div class="chip" onclick="handleChip('RELIANCE')">RELIANCE</div>
        <div class="chip" onclick="handleChip('TCS')">TCS</div>
        <div class="chip" onclick="handleChip('INFY')">INFY</div>
    </div>

    <div class="input-wrapper">
        <div class="input-box">
            <input type="text" id="symbolInp" placeholder="Symbol enter cheyyu..." autocomplete="off">
            <button class="send-btn" id="sendBtn"><i class="fas fa-arrow-up"></i></button>
        </div>
    </div>

    <div class="ad-footer" id="adFooter" onclick="window.open('https://glider-app.pages.dev', '_blank')">
        <div class="close-ad" id="closeAdBtn"><i class="fas fa-times"></i></div>
        <img src="asset/banner.jpg" alt="[Glider Banner]" onerror="this.style.display='none'">
    </div>
</div>

<script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('symbolInp');
    const sendBtn = document.getElementById('sendBtn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');

    document.getElementById('menuBtn').onclick = () => { sidebar.classList.add('open'); overlay.style.display = 'block'; };
    document.getElementById('closeMenu').onclick = () => { sidebar.classList.remove('open'); overlay.style.display = 'none'; };
    overlay.onclick = () => { sidebar.classList.remove('open'); overlay.style.display = 'none'; };
    document.getElementById('closeAdBtn').onclick = (e) => { e.stopPropagation(); document.getElementById('adFooter').style.display = 'none'; };

    function handleChip(sym) { input.value = sym; processRequest(); }
    sendBtn.onclick = processRequest;
    input.onkeypress = (e) => { if(e.key === 'Enter') processRequest(); };

    function addMessage(html, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = `<div class="bubble">${html}</div>`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        return div;
    }

    async function fetchData(url) {
        try {
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}&cache=${Date.now()}`);
            const data = await res.json();
            return JSON.parse(data.contents);
        } catch (e) {
            const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
            return await res.json();
        }
    }

    function initChart(containerId, data) {
        const container = document.getElementById(containerId);
        const chart = LightweightCharts.createChart(container, {
            layout: { backgroundColor: '#0a0a0a', textColor: '#888' },
            grid: { vertLines: { color: '#1a1a1a' }, horzLines: { color: '#1a1a1a' } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            rightPriceScale: { borderColor: '#2d2d2d' },
            timeScale: { borderColor: '#2d2d2d' },
            handleScroll: false,
            handleScale: false,
        });

        const lineSeries = chart.addLineSeries({ 
            color: '#10a37f', 
            lineWidth: 2,
            priceFormat: { type: 'price', precision: 2, minMove: 0.05 }
        });
        
        // Mapping Yahoo historical data to TradingView format
        const chartData = data.timestamp.map((t, i) => ({
            time: t,
            value: data.indicators.quote[0].close[i]
        })).filter(d => d.value !== null);

        lineSeries.setData(chartData);
        chart.timeScale().fitContent();
    }

    async function processRequest() {
        let sym = input.value.trim().toUpperCase();
        if(!sym) return;
        let formattedSym = sym.includes('.') ? sym : `${sym}.NS`;
        
        addMessage(sym, 'user');
        input.value = '';

        const loader = addMessage(`<i class="fas fa-circle-notch fa-spin"></i> Analyzing ${formattedSym}...`, 'bot');

        try {
            // Fetching Quote and 1-day historical data (5m interval) for the chart
            const quoteUrl = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${formattedSym}`;
            const chartUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${formattedSym}?range=1d&interval=5m`;
            
            const [quoteRes, chartRes] = await Promise.all([fetchData(quoteUrl), fetchData(chartUrl)]);
            const quote = quoteRes.quoteResponse?.result?.[0];
            const history = chartRes.chart?.result?.[0];

            loader.remove();
            if(!quote) throw new Error("Data error");

            const price = quote.regularMarketPrice;
            const change = quote.regularMarketChangePercent || 0;
            const chartId = 'chart_' + Date.now();

            let signal = "HOLD", cls = "hold";
            if(change > 1.2) { signal = "BUY"; cls = "buy"; }
            else if(change < -1.2) { signal = "SELL"; cls = "sell"; }

            addMessage(`
                <div style="font-weight:700; margin-bottom:8px;">${quote.longName || sym}</div>
                <div class="analysis-card">
                    <div class="card-row"><span class="label">Price</span><span class="value">₹${price.toLocaleString()}</span></div>
                    <div class="card-row"><span class="label">Change</span><span class="value" style="color:${change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${change.toFixed(2)}%</span></div>
                    <div class="card-row" style="border:0; margin-top:10px;">
                        <span class="signal-pill ${cls}">${signal}</span>
                        <span style="font-size:0.7rem; color:var(--text-dim); margin-left:10px;">VOL: ${(quote.regularMarketVolume/1000000).toFixed(1)}M</span>
                    </div>
                    <!-- TradingView Light Implementation -->
                    <div id="${chartId}" class="chart-container"></div>
                </div>
            `, 'bot');

            if(history) {
                setTimeout(() => initChart(chartId, history), 100);
            }

        } catch (e) {
            loader.remove();
            addMessage(`<span style="color:var(--accent-red)">Sync Failed.</span><br><small>Connection interrupted. 10 second kazhinju onnude try cheyyu.</small>`, 'bot');
        }
    }
</script>
</body>
</html>
